<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>üì∏ Scavenger Hunt Leaderboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; text-align:center; }
    h1,h2 { color:#333 }
    table { margin: 20px auto; border-collapse: collapse; width: 90%; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    th,td { padding: 12px; border:1px solid #ddd; text-align:center; }
    th { background:#222; color:#fff; }
    tr:nth-child(even){ background:#f9f9f9 }
    .first{ background:gold !important; font-weight:bold }
    .second{ background:silver !important; font-weight:bold }
    .third{ background:#cd7f32 !important; font-weight:bold }
    #photo-gallery { display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin-top:20px; }
    .photo-item { max-width:200px; text-align:center; }
    .photo-item img { width:100%; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.15); display:block; }
    .photo-link { display:inline-block; margin-top:6px; font-size:12px; color:#333; text-decoration:underline; }
    #notice { color:#b33; margin-top:8px; font-size:14px; }
  </style>
</head>
<body>
  <h1>üì∏ Scavenger Hunt Leaderboard</h1>

  <table id="leaderboard">
    <thead>
      <tr><th>Rank</th><th>Team</th><th>Clues Completed</th><th>Clues Found</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="notice" style="display:none"></div>

  <h2>üì∏ Submitted Photos</h2>
  <div id="photo-gallery"></div>

<script>
/* ========== CONFIG: published CSV link from Google Sheets ========== */
const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSQyf9-3xsKzmB9hMG8i2bNFCPTIYeUWrCCHPFvbHFVHAWCTExHt8R31yZPIk8SS33vVlCbuWEOS508/pub?output=csv";

/* ---------------- CSV parser ---------------- */
function parseCSV(text) {
  const rows = [];
  let cur = "";
  let row = [];
  let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"') {
      if (inQuotes && text[i+1] === '"') { cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (c === ',' && !inQuotes) {
      row.push(cur); cur="";
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (c === '\r' && text[i+1]==='\n') i++;
      row.push(cur); rows.push(row); row=[]; cur="";
    } else cur += c;
  }
  if (cur!=="" || row.length>0) { row.push(cur); rows.push(row); }
  return rows.filter(r => r.length>1 || (r.length===1 && r[0].trim()!==""));
}

/* ---------------- Normalize Google Drive links ---------------- */
function fixDriveLink(url) {
  if (!url) return null;
  url = url.trim();
  if (url.startsWith('"') && url.endsWith('"')) url = url.slice(1,-1);
  url = url.replace(/&amp;/g,'&');
  // Extract file ID
  let fileId = null;
  let match = url.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
  if (match) fileId = match[1];
  if (!fileId) match = url.match(/[?&]id=([a-zA-Z0-9_-]{10,})/); if (match) fileId=match[1];
  if (!fileId && /^[a-zA-Z0-9_-]{10,}$/.test(url)) fileId=url;
  if (fileId) return `https://drive.google.com/uc?export=view&id=${fileId}`;
  return url;
}

/* ---------------- Build leaderboard & gallery ---------------- */
async function loadAndRender() {
  try {
    const res = await fetch(sheetCSV);
    if (!res.ok) throw new Error("Sheet CSV fetch failed: "+res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    if (rows.length === 0) {
      document.getElementById("notice").style.display="block";
      document.getElementById("notice").textContent="No submissions yet.";
      return;
    }

    const header = rows.shift().map(h=>h.trim().toLowerCase());
    const teamIdx = 1; // Column B
    const clueIdx = 2; // Column C
    const photoIdx = 4; // Column E (links)

    const teamMap = {};
    const allPhotos = [];

    rows.forEach(r=>{
      const team=(r[teamIdx]||"").trim();
      if (!team) return;
      const clue=(r[clueIdx]||"").trim();
      let photoRaw=(r[photoIdx]||"").trim();

      if (!teamMap[team]) teamMap[team]={clues:new Set(), photos:[]};
      if (clue) teamMap[team].clues.add(clue);
      if (photoRaw) {
        // Auto-detect: use as-is if already in "uc?export=view" format
        let fixed = photoRaw.includes("uc?export=view&id=") ? photoRaw : fixDriveLink(photoRaw);
        teamMap[team].photos.push({url:fixed, original:photoRaw});
        allPhotos.push({team,url:fixed,original:photoRaw});
      }
    });

    const leaderboard = Object.keys(teamMap).map(team=>({
      team,
      count: teamMap[team].clues.size,
      found: Array.from(teamMap[team].clues).sort(),
      photos: teamMap[team].photos
    }));
    leaderboard.sort((a,b)=>b.count - a.count);

    // Render table
    const tbody = document.querySelector("#leaderboard tbody");
    tbody.innerHTML="";
    leaderboard.forEach((row,i)=>{
      const tr=document.createElement("tr");
      if(i===0) tr.classList.add("first");
      if(i===1) tr.classList.add("second");
      if(i===2) tr.classList.add("third");
      tr.innerHTML=`<td>${i+1} ${i===0?"üèÜ":i===1?"ü•à":i===2?"ü•â":""}</td>
                    <td>${escapeHtml(row.team)}</td>
                    <td>${row.count}</td>
                    <td>${escapeHtml(row.found.join(", "))}</td>`;
      tbody.appendChild(tr);
    });

    // Render photos (thumbnails)
    const gallery = document.getElementById("photo-gallery");
    gallery.innerHTML="";
    allPhotos.reverse().forEach(p=>{
      const wrapper=document.createElement("div");
      wrapper.className="photo-item";

      const thumb=document.createElement("img");
      thumb.src=p.url;
      thumb.alt=`${p.team} - photo`;
      thumb.style.width="150px";
      thumb.style.height="150px";
      thumb.style.objectFit="cover";
      thumb.style.cursor="pointer";

      thumb.onclick = ()=>window.open(p.url,"_blank");

      thumb.onerror=function(){
        thumb.style.display="none";
        const link=document.createElement("a");
        link.href=p.url||p.original;
        link.target="_blank";
        link.className="photo-link";
        link.textContent="View photo (may require permission)";
        wrapper.appendChild(link);
        document.getElementById("notice").style.display="block";
        document.getElementById("notice").textContent="Some photos failed to load ‚Äî if they don't open in a new tab, set the Drive folder to 'Anyone with the link can view'.";
      };

      wrapper.appendChild(thumb);

      const caption=document.createElement("div");
      caption.style.marginTop="6px";
      caption.style.fontSize="13px";
      caption.style.color="#333";
      caption.textContent=p.team;
      wrapper.appendChild(caption);

      gallery.appendChild(wrapper);
    });

  } catch(err) {
    console.error("Error building leaderboard:",err);
    document.getElementById("notice").style.display="block";
    document.getElementById("notice").textContent="Error loading data (see console).";
  }
}

function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

loadAndRender();
setInterval(loadAndRender,30000);
</script>
</body>
</html>
