<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>üì∏ Scavenger Hunt Leaderboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; text-align:center; }
    h1,h2 { color:#333 }
    table { margin: 20px auto; border-collapse: collapse; width: 90%; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    th,td { padding: 12px; border:1px solid #ddd; text-align:center; }
    th { background:#222; color:#fff; }
    tr:nth-child(even){ background:#f9f9f9 }
    .first{ background:gold !important; font-weight:bold }
    .second{ background:silver !important; font-weight:bold }
    .third{ background:#cd7f32 !important; font-weight:bold }
    #notice { color:#b33; margin-top:8px; font-size:14px; }
  </style>
</head>
<body>
  <h1>üì∏ Scavenger Hunt Leaderboard</h1>

  <table id="leaderboard">
    <thead>
      <tr><th>Rank</th><th>Team</th><th># Selfies</th><th>Selfies Completed</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="notice" style="display:none"></div>

  <h2>üì∏ Submitted Photos</h2>
  <p>
    <a href="https://photos.app.goo.gl/SijyD2nPeQy3rGUc8" target="_blank">
      View all submitted photos in Google Drive
    </a>
  </p>

<script>
/* ========== CONFIG: published CSV link from Google Sheets ========== */
const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSQyf9-3xsKzmB9hMG8i2bNFCPTIYeUWrCCHPFvbHFVHAWCTExHt8R31yZPIk8SS33vVlCbuWEOS508/pub?output=csv";

/* ---------------- CSV parser ---------------- */
function parseCSV(text) {
  const rows = [];
  let cur = "";
  let row = [];
  let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"') {
      if (inQuotes && text[i+1] === '"') { cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (c === ',' && !inQuotes) {
      row.push(cur); cur="";
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (c === '\r' && text[i+1]==='\n') i++;
      row.push(cur); rows.push(row); row=[]; cur="";
    } else cur += c;
  }
  if (cur!=="" || row.length>0) { row.push(cur); rows.push(row); }
  return rows.filter(r => r.length>1 || (r.length===1 && r[0].trim()!==""));
}

/* ---------------- Build leaderboard ---------------- */
async function loadAndRender() {
  try {
    const res = await fetch(sheetCSV);
    if (!res.ok) throw new Error("Sheet CSV fetch failed: "+res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    if (rows.length === 0) {
      document.getElementById("notice").style.display="block";
      document.getElementById("notice").textContent="No submissions yet.";
      return;
    }

    const header = rows.shift().map(h=>h.trim().toLowerCase());
    const emailIdx = 1; // Column B
    const teamIdx  = 2; // Column C
    const clueIdx  = 3; // Column D

    const teamMap = {};

    rows.forEach(r=>{
      const email=(r[emailIdx]||"").trim().toLowerCase();
      const teamName=(r[teamIdx]||"").trim();
      if (!email) return;
      const clue=(r[clueIdx]||"").trim();

      if (!teamMap[email]) teamMap[email]={ name: teamName, clues:new Set() };
      if (teamName) teamMap[email].name = teamName;
      if (clue) teamMap[email].clues.add(clue);
    });

    const leaderboard = Object.keys(teamMap).map(email=>({
      team: teamMap[email].name,
      count: teamMap[email].clues.size,
      found: Array.from(teamMap[email].clues).sort()
    }));
    leaderboard.sort((a,b)=>b.count - a.count);

    // Render table
    const tbody = document.querySelector("#leaderboard tbody");
    tbody.innerHTML="";
    leaderboard.forEach((row,i)=>{
      const tr=document.createElement("tr");
      if(i===0) tr.classList.add("first");
      if(i===1) tr.classList.add("second");
      if(i===2) tr.classList.add("third");
      tr.innerHTML=`<td>${i+1} ${i===0?"üèÜ":i===1?"ü•à":i===2?"ü•â":""}</td>
                    <td>${escapeHtml(row.team)}</td>
                    <td>${row.count}</td>
                    <td>${escapeHtml(row.found.join(", "))}</td>`;
      tbody.appendChild(tr);
    });

  } catch(err) {
    console.error("Error building leaderboard:",err);
    document.getElementById("notice").style.display="block";
    document.getElementById("notice").textContent="Error loading data (see console).";
  }
}

function escapeHtml(s){ 
  return String(s||"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;");
}

loadAndRender();
setInterval(loadAndRender,30000);
</script>
</body>
</html>
